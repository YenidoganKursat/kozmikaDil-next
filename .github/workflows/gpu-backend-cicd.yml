name: GPU Backend CD

on:
  workflow_call:
    inputs:
      backend:
        description: "GPU backend to validate"
        required: false
        type: string
        default: "all"
  workflow_dispatch:
    inputs:
      backend:
        description: "GPU backend to validate"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cuda
          - rocm_hip
          - oneapi_sycl
          - opencl
          - vulkan_compute
          - metal
  schedule:
    - cron: "0 3 * * 2"

permissions:
  contents: read

concurrency:
  group: gpu-backend-cicd-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  cuda:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'cuda' }}
    runs-on: ${{ matrix.labels }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - backend: cuda
            labels: [self-hosted, linux, x64, gpu, cuda]
          - backend: cuda
            labels: [self-hosted, windows, x64, gpu, cuda]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare CUDA infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends cuda \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_${{ matrix.labels[0] }}_${{ matrix.backend }}.json
      - name: CUDA strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends cuda \
            --fail-on-unavailable cuda \
            --json-out bench/results/phase10_gpu_smoke_${{ matrix.labels[0] }}_${{ matrix.backend }}.json
      - name: Upload CUDA artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-cuda-${{ matrix.labels[0] }}
          path: |
            bench/results/phase10_gpu_infra_${{ matrix.labels[0] }}_${{ matrix.backend }}.json
            bench/results/phase10_gpu_smoke_${{ matrix.labels[0] }}_${{ matrix.backend }}.json
          if-no-files-found: warn

  rocm:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'rocm_hip' }}
    runs-on: [self-hosted, linux, x64, gpu, rocm]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare ROCm infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends rocm_hip \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_rocm_${{ runner.os }}.json
      - name: ROCm strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends rocm_hip \
            --fail-on-unavailable rocm_hip \
            --json-out bench/results/phase10_gpu_smoke_rocm_${{ runner.os }}.json
      - name: Upload ROCm artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-rocm-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_rocm_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_rocm_${{ runner.os }}.json
          if-no-files-found: warn

  oneapi-linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'oneapi_sycl' }}
    runs-on: [self-hosted, linux, x64, gpu, oneapi]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare oneAPI infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends oneapi_sycl \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_oneapi_${{ runner.os }}.json
      - name: oneAPI strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends oneapi_sycl \
            --fail-on-unavailable oneapi_sycl \
            --json-out bench/results/phase10_gpu_smoke_oneapi_${{ runner.os }}.json
      - name: Upload oneAPI artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-oneapi-linux-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_oneapi_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_oneapi_${{ runner.os }}.json
          if-no-files-found: warn

  oneapi-windows:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'oneapi_sycl' }}
    runs-on: [self-hosted, windows, x64, gpu, oneapi]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare oneAPI infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends oneapi_sycl \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_oneapi_${{ runner.os }}.json
      - name: oneAPI strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends oneapi_sycl \
            --fail-on-unavailable oneapi_sycl \
            --json-out bench/results/phase10_gpu_smoke_oneapi_${{ runner.os }}.json
      - name: Upload oneAPI artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-oneapi-windows-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_oneapi_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_oneapi_${{ runner.os }}.json
          if-no-files-found: warn

  opencl-linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'opencl' }}
    runs-on: [self-hosted, linux, x64, gpu, opencl]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare OpenCL infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends opencl \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_opencl_${{ runner.os }}.json
      - name: OpenCL strict smoke
        run: python scripts/phase10/gpu_smoke_matrix.py \
            --backends opencl \
            --fail-on-unavailable opencl \
            --json-out bench/results/phase10_gpu_smoke_opencl_${{ runner.os }}.json
      - name: Upload OpenCL artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-opencl-linux-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_opencl_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_opencl_${{ runner.os }}.json
          if-no-files-found: warn

  opencl-windows:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'opencl' }}
    runs-on: [self-hosted, windows, x64, gpu, opencl]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare OpenCL infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends opencl \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_opencl_${{ runner.os }}.json
      - name: OpenCL strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends opencl \
            --fail-on-unavailable opencl \
            --json-out bench/results/phase10_gpu_smoke_opencl_${{ runner.os }}.json
      - name: Upload OpenCL artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-opencl-windows-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_opencl_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_opencl_${{ runner.os }}.json
          if-no-files-found: warn

  vulkan-linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'vulkan_compute' }}
    runs-on: [self-hosted, linux, x64, gpu, vulkan]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare Vulkan infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends vulkan_compute \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_vulkan_${{ runner.os }}.json
      - name: Vulkan strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends vulkan_compute \
            --fail-on-unavailable vulkan_compute \
            --json-out bench/results/phase10_gpu_smoke_vulkan_${{ runner.os }}.json
      - name: Upload Vulkan artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-vulkan-linux-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_vulkan_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_vulkan_${{ runner.os }}.json
          if-no-files-found: warn

  vulkan-windows:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'vulkan_compute' }}
    runs-on: [self-hosted, windows, x64, gpu, vulkan]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare Vulkan infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends vulkan_compute \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_vulkan_${{ runner.os }}.json
      - name: Vulkan strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends vulkan_compute \
            --fail-on-unavailable vulkan_compute \
            --json-out bench/results/phase10_gpu_smoke_vulkan_${{ runner.os }}.json
      - name: Upload Vulkan artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-vulkan-windows-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_vulkan_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_vulkan_${{ runner.os }}.json
          if-no-files-found: warn

  metal:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.backend == 'all' || inputs.backend == 'metal' }}
    runs-on: macos-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Prepare Metal infra
        run: |
          python scripts/phase10/gpu_backend_infra.py \
            --backends metal \
            --provision \
            --strict \
            --json-out bench/results/phase10_gpu_infra_metal_${{ runner.os }}.json
      - name: Metal strict smoke
        run: |
          python scripts/phase10/gpu_smoke_matrix.py \
            --backends metal \
            --fail-on-unavailable metal \
            --json-out bench/results/phase10_gpu_smoke_metal_${{ runner.os }}.json
      - name: Upload Metal artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ci-gpu-backend-metal-${{ runner.os }}
          path: |
            bench/results/phase10_gpu_infra_metal_${{ runner.os }}.json
            bench/results/phase10_gpu_smoke_metal_${{ runner.os }}.json
          if-no-files-found: warn
